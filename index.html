<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kozybeats Lofi Player</title>

  <style>
    /* Reset and base styles */
    * {
      box-sizing: border-box;
    }
    body, html {
      margin: 0; padding: 0;
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #111;
      color: white;
      overflow: hidden;
      user-select: none;
    }

    /* --- Background video blurred warm orange glow (Option A) --- */
    #backgroundVideo {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      min-width: 100%;
      min-height: 100%;
      width: auto;
      height: auto;
      z-index: -2;
      filter: brightness(0.8) blur(15px) saturate(1.3) contrast(1.1) sepia(0.3);
      object-fit: cover;
      pointer-events: none;
    }

    /* Warm orange overlay glow */
    #glowOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      background: radial-gradient(circle at center, rgba(218,179,107,0.3) 0%, transparent 80%);
      mix-blend-mode: screen;
      z-index: -1;
      animation: slowPulse 10s ease-in-out infinite;
    }

    @keyframes slowPulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.45; }
    }

    /* --- Layout containers --- */
    #app {
      position: relative;
      display: flex;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      backdrop-filter: none;
    }

    /* Projects sidebar left */
    #projects {
      width: 220px;
      background: rgba(20, 20, 20, 0.85);
      border-right: 1.5px solid rgba(255 255 255 / 0.1);
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 10;
    }
    #projects::-webkit-scrollbar {
      width: 6px;
    }
    #projects::-webkit-scrollbar-thumb {
      background-color: rgba(218,179,107,0.3);
      border-radius: 3px;
    }

    .project-item {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 8px;
      border-radius: 8px;
      transition: background-color 0.3s ease;
      border: 2px solid transparent;
    }
    .project-item:hover {
      background-color: rgba(218,179,107,0.15);
    }
    .project-item.active {
      border-color: var(--button-glow);
      background-color: rgba(218,179,107,0.25);
    }
    .project-item img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 6px;
      box-shadow: 0 0 8px var(--button-glow);
      flex-shrink: 0;
    }
    .project-item span {
      font-weight: 600;
      font-size: 1rem;
      color: white;
      user-select: none;
    }

    /* Tracks list right side */
    #tracks {
      flex: 1;
      background: rgba(20, 20, 20, 0.85);
      padding: 15px 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      border-left: 1.5px solid rgba(255 255 255 / 0.1);
      z-index: 10;
    }
    #tracks::-webkit-scrollbar {
      width: 6px;
    }
    #tracks::-webkit-scrollbar-thumb {
      background-color: rgba(218,179,107,0.3);
      border-radius: 3px;
    }
    .track {
      cursor: pointer;
      padding: 10px 15px;
      border-radius: 8px;
      background: rgba(255 255 255 / 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 500;
      transition: background-color 0.25s ease;
      user-select: none;
    }
    .track:hover {
      background-color: rgba(218,179,107,0.3);
    }
    .track.active {
      background-color: var(--button-glow);
      color: black;
      font-weight: 700;
      box-shadow: 0 0 10px var(--button-glow);
    }

    /* Spotify button */
    .spotify-btn {
      background: var(--spotify-green);
      border: none;
      color: white;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.85rem;
      padding: 5px 12px;
      border-radius: 6px;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    .spotify-btn:hover {
      background: #17a44b;
    }

    /* Now playing bar bottom */
    #nowPlayingBar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100vw;
      background: rgba(20, 20, 20, 0.95);
      border-top: 1.5px solid rgba(218,179,107,0.5);
      display: flex;
      flex-direction: column;
      padding: 6px 20px 12px;
      z-index: 20;
    }
    #nowPlaying {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 6px;
      user-select: none;
    }
    #spotifyLink {
      color: var(--spotify-green);
      font-weight: 700;
      text-decoration: none;
      margin-left: 8px;
      font-size: 0.95rem;
    }
    #spotifyLink:hover {
      text-decoration: underline;
    }

    /* Controls container */
    #controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    button.control-btn {
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      padding: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    button.control-btn:hover {
      background-color: rgba(218,179,107,0.25);
    }
    button.control-btn.active {
      color: var(--button-glow);
      box-shadow: 0 0 12px var(--button-glow);
    }
    button.control-btn:focus {
      outline: 2px solid var(--button-glow);
    }

    /* Volume controls */
    #volumeControl {
      display: flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }
    #volumeSlider {
      width: 100px;
      cursor: pointer;
    }

    /* Progress bar */
    #progressContainer {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }
    #progress {
      width: 100%;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
      height: 6px;
      border-radius: 3px;
      background: rgba(255 255 255 / 0.2);
      transition: background-color 0.3s ease;
    }
    #progress::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--button-glow);
      cursor: pointer;
      border: none;
      transition: background-color 0.3s ease;
    }
    #progress::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--button-glow);
      cursor: pointer;
      border: none;
      transition: background-color 0.3s ease;
    }

    #currentTime, #duration {
      font-size: 0.9rem;
      width: 45px;
      text-align: center;
      user-select: none;
    }

    /* Vinyl spinning cover */
    #vinylContainer {
      position: fixed;
      top: 50%;
      right: 20px;
      width: 160px;
      height: 160px;
      border-radius: 50%;
      overflow: hidden;
      box-shadow: 0 0 30px var(--button-glow);
      transform: translateY(-50%);
      background: black;
      user-select: none;
      z-index: 15;
    }
    #vinyl {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
      animation: spin 20s linear infinite;
      pointer-events: none;
    }

    @keyframes spin {
      from { transform: rotate(0deg);}
      to { transform: rotate(360deg);}
    }

    /* Ambient sounds panel */
    #ambientPanel {
      position: fixed;
      bottom: 70px;
      right: 20px;
      background: rgba(20, 20, 20, 0.9);
      border: 1.5px solid var(--button-glow);
      border-radius: 12px;
      padding: 16px 20px;
      display: none;
      flex-direction: column;
      gap: 12px;
      width: 240px;
      color: white;
      z-index: 30;
      user-select: none;
      box-shadow: 0 0 20px var(--button-glow);
    }
    #ambientPanel label {
      display: flex;
      justify-content: space-between;
      font-weight: 600;
      font-size: 1rem;
    }
    #ambientPanel input[type="range"] {
      width: 100%;
      cursor: pointer;
    }
    #ambientCloseBtn {
      align-self: flex-end;
      background: transparent;
      border: none;
      color: var(--button-glow);
      font-size: 1.4rem;
      cursor: pointer;
      user-select: none;
    }

    /* Ambient toggle button */
    #ambientBtn {
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      user-select: none;
      transition: background-color 0.3s ease;
      display: flex;
      align-items: center;
    }
    #ambientBtn:hover {
      background-color: rgba(218,179,107,0.25);
    }

    /* Glow color variables & classes */
    :root {
      --glow-color-start: rgba(156, 119, 75, 0.95);
      --glow-color-end: rgba(218, 179, 107, 0.95);
      --glow-shadow-color: rgba(156, 119, 75, 0.4);
      --button-glow: #dab36b;
      --spotify-green: #1DB954;
    }
    body.glow-orange {
      --glow-color-start: rgba(156, 119, 75, 0.95);
      --glow-color-end: rgba(218, 179, 107, 0.95);
      --glow-shadow-color: rgba(156, 119, 75, 0.4);
      --button-glow: #dab36b;
    }
    body.glow-purple {
      --glow-color-start: rgba(124, 58, 237, 0.95);
      --glow-color-end: rgba(168, 85, 247, 0.95);
      --glow-shadow-color: rgba(124, 58, 237, 0.4);
      --button-glow: #a855f7;
    }
    body.glow-blue {
      --glow-color-start: rgba(59, 130, 246, 0.95);
      --glow-color-end: rgba(96, 165, 250, 0.95);
      --glow-shadow-color: rgba(59, 130, 246, 0.4);
      --button-glow: #3b82f6;
    }
    body.glow-green {
      --glow-color-start: rgba(22, 163, 74, 0.95);
      --glow-color-end: rgba(34, 197, 94, 0.95);
      --glow-shadow-color: rgba(22, 163, 74, 0.4);
      --button-glow: #16a34a;
    }
    body.glow-pink {
      --glow-color-start: rgba(236, 72, 153, 0.95);
      --glow-color-end: rgba(244, 114, 182, 0.95);
      --glow-shadow-color: rgba(236, 72, 153, 0.4);
      --button-glow: #ec4899;
    }

    /* Use glow variables for glow overlay */
    #glowOverlay {
      background: radial-gradient(circle at center, var(--glow-color-end) 0%, transparent 80%);
      box-shadow: 0 0 30px var(--glow-shadow-color);
    }
    .notification {
      background: linear-gradient(135deg, var(--glow-color-start), var(--glow-color-end));
      box-shadow: 0 8px 25px var(--glow-shadow-color);
      border: 1px solid rgba(255 255 255 / 0.2);
      color: white;
    }

    /* Control buttons active highlight */
    #shuffle.active, #repeat.active {
      color: var(--button-glow) !important;
      text-shadow: 0 0 6px var(--button-glow);
    }

    /* Color selector dropdown top right */
    #colorSelector {
      position: fixed;
      top: 16px;
      right: 16px;
      padding: 6px 12px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1.5px solid #ccc;
      background: white;
      color: #333;
      cursor: pointer;
      user-select: none;
      z-index: 1000;
      box-shadow: 0 0 8px rgba(0,0,0,0.15);
      transition: border-color 0.3s ease;
      font-weight: 600;
    }
    #colorSelector:focus {
      outline: none;
      border-color: var(--button-glow);
      box-shadow: 0 0 10px var(--button-glow);
    }
  </style>
</head>
<body class="glow-orange">

  <!-- Background video -->
  <video id="backgroundVideo" autoplay muted loop playsinline>
    <source src="https://res.cloudinary.com/dvtt0ymce/video/upload/v1754233437/mushroom_cat_loop.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
  <div id="glowOverlay"></div>

  <!-- Color glow selector dropdown -->
  <select id="colorSelector" aria-label="Select Site Glow Color" title="Select Glow Color">
    <option value="glow-orange" selected>Orange</option>
    <option value="glow-purple">Purple</option>
    <option value="glow-blue">Blue</option>
    <option value="glow-green">Green</option>
    <option value="glow-pink">Pink</option>
  </select>

  <!-- Main app container -->
  <div id="app">
    <!-- Projects sidebar -->
    <div id="projects" aria-label="Projects List" role="listbox" tabindex="0"></div>

    <!-- Tracks container -->
    <div id="tracks" aria-label="Tracks List" role="list" tabindex="0"></div>

    <!-- Vinyl spinning cover -->
    <div id="vinylContainer" aria-label="Current Track Cover Art">
      <img id="vinyl" alt="Vinyl cover art" src="" draggable="false" />
    </div>
  </div>

  <!-- Now Playing and controls bar -->
  <div id="nowPlayingBar" role="region" aria-live="polite" aria-atomic="true">
    <div id="nowPlaying">Now Playing: Kozybeats - <span id="trackTitle"></span></div>
    <a id="spotifyLink" href="#" target="_blank" rel="noopener" aria-label="Open current track in Spotify" style="display:none;">Open in Spotify</a>
    <div id="controls" role="group" aria-label="Audio Controls">
      <button id="prev" class="control-btn" aria-label="Previous track" title="Previous track"><i data-feather="skip-back"></i></button>
      <button id="playPause" class="control-btn" aria-label="Play/Pause" title="Play/Pause"><i data-feather="play"></i></button>
      <button id="next" class="control-btn" aria-label="Next track" title="Next track"><i data-feather="skip-forward"></i></button>
      <button id="shuffle" class="control-btn" aria-pressed="false" aria-label="Toggle shuffle" title="Shuffle"><i data-feather="shuffle"></i></button>
      <button id="repeat" class="control-btn" aria-pressed="false" aria-label="Toggle repeat" title="Repeat"><i data-feather="repeat"></i></button>

      <div id="progressContainer" aria-label="Seek bar and time display">
        <span id="currentTime" aria-live="off">00:00</span>
        <input type="range" id="progress" min="0" max="100" step="0.1" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Seek audio position" />
        <span id="duration" aria-live="off">00:00</span>
      </div>

      <div id="volumeControl" aria-label="Volume controls">
        <button id="mute" class="control-btn" aria-label="Mute/Unmute" title="Mute/Unmute"><i data-feather="volume-2" id="volumeIcon"></i></button>
        <input type="range" id="volumeSlider" min="0" max="1" step="0.01" aria-valuemin="0" aria-valuemax="1" aria-valuenow="1" aria-label="Volume control" />
      </div>

      <button id="ambientBtn" class="control-btn" aria-label="Toggle ambient sounds panel" title="Ambient sounds"><i data-feather="cloud-drizzle"></i></button>
    </div>
  </div>

  <!-- Ambient sounds panel -->
  <div id="ambientPanel" role="region" aria-label="Ambient sounds controls" aria-hidden="true">
    <button id="ambientCloseBtn" aria-label="Close ambient sounds panel" title="Close ambient sounds panel">&times;</button>
    <label for="rainVolSlider">Rain Volume
      <input type="range" id="rainVolSlider" min="0" max="1" step="0.01" value="0" aria-valuemin="0" aria-valuemax="1" aria-valuenow="0" />
    </label>
    <label for="vinylCrackleVolSlider">Vinyl Crackle Volume
      <input type="range" id="vinylCrackleVolSlider" min="0" max="1" step="0.01" value="0" aria-valuemin="0" aria-valuemax="1" aria-valuenow="0" />
    </label>
  </div>

  <!-- Audio element -->
  <audio id="audio" preload="metadata"></audio>

  <!-- Ambient audio elements -->
  <audio id="rain" loop preload="auto" src="https://cdn.pixabay.com/download/audio/2022/03/25/audio_a814df11b5.mp3?filename=rain-ambient-7586.mp3"></audio>
  <audio id="vinylCrackle" loop preload="auto" src="https://cdn.pixabay.com/download/audio/2022/02/18/audio_5c0a1a9f01.mp3?filename=vinyl-crackle-loop-7055.mp3"></audio>

  <!-- Feather icons CDN -->
  <script src="https://unpkg.com/feather-icons"></script>

  <script>
    // Projects and tracks data
    const projects = [
      {
        id: 'eveningStatic',
        name: 'Evening Static',
        cover: 'https://res.cloudinary.com/dvtt0ymce/image/upload/v1754229102/056f89b5bdd7b2944636c4e480196abe_1_bhyub6.jpg',
        spotifyPrefix: 'https://open.spotify.com/track/',
        tracks: [
          { title: 'Curtains Breathing Slow', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754230006/track1.mp3', spotifyId: '1a2b3c4d' },
          { title: 'Heard My Name in the Hiss', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754230007/track2.mp3', spotifyId: '' },
          { title: 'Stayed Just Long Enough', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754230008/track3.mp3', spotifyId: '4d3c2b1a' },
          { title: 'Memories on the Window Glass', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754230009/track4.mp3', spotifyId: '' },
          { title: 'TV Snow in My Mind', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754230010/track5.mp3', spotifyId: '9f8e7d6c' },
          { title: 'Pages Left Open', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754230011/track6.mp3', spotifyId: '' },
          { title: 'The Fan Still Spins', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754230012/track7.mp3', spotifyId: '' },
          { title: 'When the Floorboard Creaked', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754230013/track8.mp3', spotifyId: '0a1b2c3d' },
          { title: 'A Thread Pulled from the Moon', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754230014/track9.mp3', spotifyId: '' },
          { title: 'Between the Glow and the Silence', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754230015/track10.mp3', spotifyId: '' }
        ]
      },
      {
        id: 'pillowcoreRadio',
        name: 'Pillowcore Radio',
        cover: 'https://res.cloudinary.com/dvtt0ymce/image/upload/v1754231234/pillowcore_cover.jpg',
        spotifyPrefix: 'https://open.spotify.com/track/',
        tracks: [
          { title: 'Soft Tides', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754232001/pillow1.mp3', spotifyId: 'abc123xyz' },
          { title: 'Lazy Afternoon', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754232002/pillow2.mp3', spotifyId: '' },
          { title: 'Sunset Haze', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754232003/pillow3.mp3', spotifyId: 'def456uvw' },
          { title: 'Night Whispers', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754232004/pillow4.mp3', spotifyId: '' },
          { title: 'City Lights', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754232005/pillow5.mp3', spotifyId: '' },
          { title: 'Slow Dance', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754232006/pillow6.mp3', spotifyId: '' },
          { title: 'Quiet Streets', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754232007/pillow7.mp3', spotifyId: '' },
          { title: 'Dreamscape', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754232008/pillow8.mp3', spotifyId: '' },
          { title: 'Last Ember', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754232009/pillow9.mp3', spotifyId: '' },
          { title: 'Warmth', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754232010/pillow10.mp3', spotifyId: '' },
          { title: 'Fade Away', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754232011/pillow11.mp3', spotifyId: '' },
          { title: 'Underneath the Stars', url: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754232012/pillow12.mp3', spotifyId: '' }
        ]
      }
    ];

    // State
    let currentProjectId = projects[0].id;
    let currentTrackIndex = 0;
    let isPlaying = false;
    let isShuffle = false;
    let isRepeat = false;

    // Elements
    const projectsContainer = document.getElementById('projects');
    const tracksContainer = document.getElementById('tracks');
    const vinyl = document.getElementById('vinyl');
    const nowPlaying = document.getElementById('nowPlaying');
    const trackTitle = document.getElementById('trackTitle');
    const spotifyLink = document.getElementById('spotifyLink');
    const audio = document.getElementById('audio');

    const playPauseBtn = document.getElementById('playPause');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const shuffleBtn = document.getElementById('shuffle');
    const repeatBtn = document.getElementById('repeat');

    const progress = document.getElementById('progress');
    const currentTimeEl = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');

    const volumeSlider = document.getElementById('volumeSlider');
    const muteBtn = document.getElementById('mute');
    const volumeIcon = document.getElementById('volumeIcon');

    const ambientBtn = document.getElementById('ambientBtn');
    const ambientPanel = document.getElementById('ambientPanel');
    const ambientCloseBtn = document.getElementById('ambientCloseBtn');

    const rainVolSlider = document.getElementById('rainVolSlider');
    const vinylCrackleVolSlider = document.getElementById('vinylCrackleVolSlider');

    const ambientSounds = {
      rain: document.getElementById('rain'),
      vinylCrackle: document.getElementById('vinylCrackle'),
    };

    // --- Render Projects List ---
    function renderProjects() {
      projectsContainer.innerHTML = '';
      projects.forEach(project => {
        const div = document.createElement('div');
        div.classList.add('project-item');
        if (project.id === currentProjectId) div.classList.add('active');
        div.setAttribute('role', 'option');
        div.setAttribute('aria-selected', project.id === currentProjectId ? 'true' : 'false');
        div.tabIndex = 0;

        const img = document.createElement('img');
        img.src = project.cover;
        img.alt = `${project.name} cover art`;
        div.appendChild(img);

        const span = document.createElement('span');
        span.textContent = project.name;
        div.appendChild(span);

        div.addEventListener('click', () => {
          if (project.id !== currentProjectId) {
            currentProjectId = project.id;
            currentTrackIndex = 0;
            renderProjects();
            renderTracks();
            loadTrack();
          }
        });
        div.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            div.click();
          }
        });

        projectsContainer.appendChild(div);
      });
    }

    // --- Render Tracks List ---
    function renderTracks() {
      tracksContainer.innerHTML = '';
      const project = projects.find(p => p.id === currentProjectId);
      project.tracks.forEach((track, idx) => {
        const div = document.createElement('div');
        div.classList.add('track');
        if (idx === currentTrackIndex) div.classList.add('active');
        div.tabIndex = 0;
        div.setAttribute('role', 'listitem');

        div.textContent = track.title;

        // Spotify button if available
        if (track.spotifyId) {
          const spotifyBtn = document.createElement('a');
          spotifyBtn.href = project.spotifyPrefix + track.spotifyId;
          spotifyBtn.target = '_blank';
          spotifyBtn.rel = 'noopener noreferrer';
          spotifyBtn.classList.add('spotify-btn');
          spotifyBtn.textContent = 'Spotify';
          spotifyBtn.setAttribute('aria-label', `Open ${track.title} on Spotify`);
          spotifyBtn.tabIndex = 0;
          div.appendChild(spotifyBtn);
        }

        div.addEventListener('click', () => {
          if (idx !== currentTrackIndex) {
            currentTrackIndex = idx;
            loadTrack();
            playAudio();
            renderTracks();
          }
        });
        div.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            div.click();
          }
        });

        tracksContainer.appendChild(div);
      });
    }

    // --- Load Track ---
    function loadTrack() {
      const project = projects.find(p => p.id === currentProjectId);
      const track = project.tracks[currentTrackIndex];
      audio.src = track.url;
      trackTitle.textContent = track.title;
      nowPlaying.textContent = `Now Playing: Kozybeats - ${track.title}`;
      spotifyLink.style.display = track.spotifyId ? 'inline-block' : 'none';
      spotifyLink.href = track.spotifyId ? project.spotifyPrefix + track.spotifyId : '#';
      vinyl.src = trackCoverFromUrl(track.url) || project.cover;
      updatePlayPauseIcon();
    }

    // Helper: get project cover from track url
    function trackCoverFromUrl(url) {
      const project = projects.find(p => p.tracks.some(t => t.url === url));
      return project ? project.cover : null;
    }

    // --- Playback Controls ---
    function playAudio() {
      audio.play();
      isPlaying = true;
      updatePlayPauseIcon();
    }
    function pauseAudio() {
      audio.pause();
      isPlaying = false;
      updatePlayPauseIcon();
    }
    function togglePlayPause() {
      if (isPlaying) pauseAudio();
      else playAudio();
    }
    function updatePlayPauseIcon() {
      playPauseBtn.innerHTML = '';
      const iconName = isPlaying ? 'pause' : 'play';
      const icon = document.createElement('i');
      icon.setAttribute('data-feather', iconName);
      playPauseBtn.appendChild(icon);
      feather.replace();
    }

    // --- Track Navigation ---
    function nextTrack() {
      const project = projects.find(p => p.id === currentProjectId);
      if (isShuffle) {
        currentTrackIndex = getRandomTrackIndex();
      } else {
        currentTrackIndex++;
        if (currentTrackIndex >= project.tracks.length) {
          // End of tracks in project
          const currentProjectIndex = projects.findIndex(p => p.id === currentProjectId);
          if (isRepeat) {
            currentTrackIndex = 0;
          } else if (currentProjectIndex < projects.length - 1) {
            // Move to next project and first track
            currentProjectId = projects[currentProjectIndex + 1].id;
            currentTrackIndex = 0;
            renderProjects();
            renderTracks();
            loadTrack();
            if (isPlaying) playAudio();
            return;
          } else {
            // Last track of last project
            currentTrackIndex = project.tracks.length - 1;
            pauseAudio();
            return;
          }
        }
      }
      loadTrack();
      if (isPlaying) playAudio();
      renderTracks();
    }

    function prevTrack() {
      const project = projects.find(p => p.id === currentProjectId);
      if (isShuffle) {
        currentTrackIndex = getRandomTrackIndex();
      } else {
        currentTrackIndex--;
        if (currentTrackIndex < 0) {
          if (isRepeat) {
            currentTrackIndex = project.tracks.length - 1;
          } else {
            currentTrackIndex = 0;
            pauseAudio();
            return;
          }
        }
      }
      loadTrack();
      if (isPlaying) playAudio();
      renderTracks();
    }

    function getRandomTrackIndex() {
      const project = projects.find(p => p.id === currentProjectId);
      return Math.floor(Math.random() * project.tracks.length);
    }

    function toggleShuffle() {
      isShuffle = !isShuffle;
      shuffleBtn.classList.toggle('active', isShuffle);
      shuffleBtn.setAttribute('aria-pressed', isShuffle);
    }
    function toggleRepeat() {
      isRepeat = !isRepeat;
      repeatBtn.classList.toggle('active', isRepeat);
      repeatBtn.setAttribute('aria-pressed', isRepeat);
    }

    // --- Progress Bar and Time ---
    function updateProgress() {
      if (!audio.duration) return;
      const percent = (audio.currentTime / audio.duration) * 100;
      progress.value = percent;

      currentTimeEl.textContent = formatTime(audio.currentTime);
      durationEl.textContent = formatTime(audio.duration);
      progress.setAttribute('aria-valuenow', percent.toFixed(1));
    }
    function formatTime(sec) {
      const minutes = Math.floor(sec / 60) || 0;
      const seconds = Math.floor(sec % 60) || 0;
      return `${minutes < 10 ? '0' + minutes : minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
    }
    function setProgress() {
      if (!audio.duration) return;
      const seekTime = (progress.value / 100) * audio.duration;
      audio.currentTime = seekTime;
    }

    // --- Volume Control and Mute ---
    function updateVolumeIcon() {
      if (audio.muted || audio.volume === 0) {
        volumeIcon.setAttribute('data-feather', 'volume-x');
      } else if (audio.volume > 0 && audio.volume <= 0.5) {
        volumeIcon.setAttribute('data-feather', 'volume-1');
      } else {
        volumeIcon.setAttribute('data-feather', 'volume-2');
      }
      feather.replace();
    }
    function toggleMute() {
      audio.muted = !audio.muted;
      if (audio.muted) {
        volumeSlider.value = 0;
      } else {
        volumeSlider.value = audio.volume;
      }
      updateVolumeIcon();
    }

    // --- Ambient Sounds Controls ---
    rainVolSlider.addEventListener('input', () => {
      ambientSounds.rain.volume = rainVolSlider.value;
      if (rainVolSlider.value > 0) ambientSounds.rain.play();
      else ambientSounds.rain.pause();
    });
    vinylCrackleVolSlider.addEventListener('input', () => {
      ambientSounds.vinylCrackle.volume = vinylCrackleVolSlider.value;
      if (vinylCrackleVolSlider.value > 0) ambientSounds.vinylCrackle.play();
      else ambientSounds.vinylCrackle.pause();
    });

    ambientBtn.addEventListener('click', () => {
      const isVisible = ambientPanel.style.display === 'flex';
      ambientPanel.style.display = isVisible ? 'none' : 'flex';
      ambientPanel.setAttribute('aria-hidden', isVisible ? 'true' : 'false');
    });
    ambientCloseBtn.addEventListener('click', () => {
      ambientPanel.style.display = 'none';
      ambientPanel.setAttribute('aria-hidden', 'true');
    });

    // --- Event Listeners ---
    volumeSlider.addEventListener('input', (e) => {
      audio.volume = e.target.value;
      audio.muted = false;
      updateVolumeIcon();
    });
    muteBtn.addEventListener('click', toggleMute);

    audio.addEventListener('timeupdate', updateProgress);
    audio.addEventListener('ended', () => {
      if (isRepeat) {
        audio.currentTime = 0;
        playAudio();
      } else {
        nextTrack();
      }
    });

    progress.addEventListener('input', setProgress);

    playPauseBtn.addEventListener('click', togglePlayPause);
    prevBtn.addEventListener('click', prevTrack);
    nextBtn.addEventListener('click', nextTrack);
    shuffleBtn.addEventListener('click', toggleShuffle);
    repeatBtn.addEventListener('click', toggleRepeat);

    // --- Glow Color Selector ---
    const colorSelector = document.getElementById('colorSelector');
    colorSelector.addEventListener('change', (e) => {
      const val = e.target.value;
      document.body.className = val;
    });

    // --- Initialize ---
    renderProjects();
    renderTracks();
    loadTrack();

    // Initial volume & icon setup
    audio.volume = 0.8;
    volumeSlider.value = 0.8;
    updateVolumeIcon();

    // Initialize feather icons
    feather.replace();
  </script>

</body>
</html>

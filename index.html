<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KozyBeats Lofi Station</title>
<style>
  /* Reset and base styles */
  html, body {
    margin: 0; padding: 0;
    height: 100%;
    background: #000;
    color: #fff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    overflow: hidden;
  }
  a {
    color: #ffa500;
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }

  /* Background video */
  #bgVideo {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    object-fit: cover;
    filter: brightness(0.6) blur(8px);
    z-index: -10;
  }

  /* Particles container */
  #particles {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    pointer-events: none;
    z-index: -5;
  }
  .particle {
    position: absolute;
    width: 5px; height: 5px;
    background: rgba(255,255,255,0.15);
    border-radius: 50%;
    animation-name: drift;
    animation-timing-function: linear;
    animation-iteration-count: infinite;
  }
  @keyframes drift {
    0% {
      transform: translateY(0);
      opacity: 1;
    }
    100% {
      transform: translateY(100vh);
      opacity: 0;
    }
  }

  /* Layout */
  .container {
    display: flex;
    height: 100vh;
    overflow: hidden;
  }

  /* Left side - projects */
  #projectList {
    width: 20%;
    background: rgba(0,0,0,0.4);
    overflow-y: auto;
    padding: 20px;
    box-sizing: border-box;
  }
  #projectList::-webkit-scrollbar {
    width: 8px;
  }
  #projectList::-webkit-scrollbar-thumb {
    background-color: rgba(255,165,0,0.7);
    border-radius: 4px;
  }
  .project {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    cursor: pointer;
    transition: background 0.3s ease;
    padding: 5px;
    border-radius: 8px;
  }
  .project:hover, .project.active {
    background: rgba(255,165,0,0.15);
  }
  .project img {
    width: 50px; height: 50px;
    object-fit: cover;
    border-radius: 6px;
    margin-right: 10px;
    box-shadow: 0 0 10px rgba(255,165,0,0.5);
  }
  .project-name {
    font-weight: 600;
    font-size: 1rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Right side - track list */
  #trackList {
    width: 25%;
    background: rgba(0,0,0,0.4);
    overflow-y: auto;
    padding: 20px;
    box-sizing: border-box;
  }
  #trackList::-webkit-scrollbar {
    width: 8px;
  }
  #trackList::-webkit-scrollbar-thumb {
    background-color: rgba(255,165,0,0.7);
    border-radius: 4px;
  }
  .track {
    background: rgba(255, 165, 0, 0.1);
    margin-bottom: 12px;
    border-radius: 12px;
    padding: 10px 15px;
    cursor: pointer;
    transition: background 0.25s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .track:hover, .track.active {
    background: rgba(255,165,0,0.3);
  }
  .track-info {
    flex: 1;
    overflow: hidden;
  }
  .track-title {
    font-weight: 600;
    font-size: 1rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .track-duration {
    font-size: 0.85rem;
    opacity: 0.75;
    margin-left: 10px;
    white-space: nowrap;
  }
  .spotify-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 5px;
    margin-left: 10px;
    filter: brightness(0.8);
    transition: filter 0.3s ease;
  }
  .spotify-btn:hover {
    filter: brightness(1);
  }
  .spotify-icon {
    width: 20px;
    height: 20px;
  }

  /* Center area */
  .main {
    flex: 1;
    background: rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    padding: 20px;
    box-sizing: border-box;
  }

  /* Vinyl spinning */
  #vinyl {
    width: 220px;
    height: 220px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    box-shadow:
      inset 0 0 60px rgba(255,165,0,0.6),
      0 0 40px rgba(255,165,0,0.8);
    animation: spin 8s linear infinite;
    margin-bottom: 25px;
  }
  @keyframes spin {
    0% {transform: rotate(0);}
    100% {transform: rotate(360deg);}
  }

  /* Now playing text */
  #nowPlaying {
    font-size: 1.25rem;
    margin-bottom: 15px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 320px;
    text-align: center;
  }

  /* Controls */
  .controls {
    display: flex;
    gap: 15px;
    align-items: center;
    margin-top: 10px;
  }

  button.control-btn {
    background: rgba(255,165,0,0.9);
    border: none;
    color: #000;
    font-size: 1.3rem;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    cursor: pointer;
    box-shadow: 0 0 10px rgba(255,165,0,0.8);
    transition: background 0.3s ease;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  button.control-btn:hover {
    background: rgba(255,165,0,1);
  }
  button.control-btn svg {
    width: 24px;
    height: 24px;
    fill: #000;
  }

  /* Seek bar */
  #seekBar {
    width: 320px;
    margin-top: 10px;
  }

  /* Volume slider */
  #volumeSlider {
    width: 100px;
    margin-left: 20px;
  }

  /* Ambience panel */
  .ambience-panel {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: rgba(0,0,0,0.45);
    border-radius: 12px;
    padding: 15px;
    max-width: 250px;
    font-size: 0.9rem;
    z-index: 50;
  }
  .ambience-panel label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
    color: #ffa500;
  }
  .ambience-panel input[type="range"] {
    width: 100px;
  }

  /* Scrollbar for project and track list */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  ::-webkit-scrollbar-thumb {
    background-color: rgba(255,165,0,0.5);
    border-radius: 4px;
  }
  ::-webkit-scrollbar-track {
    background: transparent;
  }
</style>
</head>
<body>

<video id="bgVideo" autoplay muted loop playsinline>
  <source src="https://res.cloudinary.com/dvtt0ymce/video/upload/v1754228640/Cat_Mushroom_Animated_Digital_Wide_PC_Background_HD_Live_-_Etsy_Video_Video___Anime_wallpaper_Cute_wallpapers_Art_whcjmg.mp4" type="video/mp4" />
</video>

<div id="particles"></div>

<div class="container">

  <div id="projectList" aria-label="Project List" role="list"></div>

  <div class="main">
    <div id="vinyl" aria-label="Spinning vinyl cover"></div>
    <div id="nowPlaying" aria-live="polite" aria-atomic="true">Now Playing: ‚Äî</div>
    <input type="range" id="seekBar" value="0" min="0" max="100" aria-label="Seek Bar" />
    <div class="controls">
      <button id="prevBtn" class="control-btn" aria-label="Previous Track" title="Previous Track">
        <svg viewBox="0 0 24 24"><path d="M6 6v12l9-6z"/><path d="M19 6v12h-2V6z"/></svg>
      </button>
      <button id="playPauseBtn" class="control-btn" aria-label="Play" title="Play">
        <svg id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        <svg id="pauseIcon" viewBox="0 0 24 24" style="display:none;"><path d="M6 19h4V5H6zm8-14v14h4V5z"/></svg>
      </button>
      <button id="nextBtn" class="control-btn" aria-label="Next Track" title="Next Track">
        <svg viewBox="0 0 24 24"><path d="M18 6v12l-9-6z"/><path d="M5 6v12h2V6z"/></svg>
      </button>
      <button id="repeatBtn" class="control-btn" aria-label="Repeat Off" title="Toggle Repeat">
        <svg id="repeatIcon" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H7c-1.66 0-3 1.34-3 3v3h2V9c0-.55.45-1 1-1zM17 17H7v-3l-4 4 4 4v-3h10c1.66 0 3-1.34 3-3v-3h-2v3c0 .55-.45 1-1 1z"/></svg>
      </button>
      <button id="shuffleBtn" class="control-btn" aria-label="Shuffle Off" title="Toggle Shuffle">
        <svg id="shuffleIcon" viewBox="0 0 24 24"><path d="M16 3h5v5h-2V6.41l-7.34 7.34-2.83-2.83-1.42 1.42 4.24 4.24 8.49-8.49V11h2V3h-5v2zM3 6v2h2V6H3zm0 10v-2H1v4h4v-2H3zm0-6h2v2H3v-2z"/></svg>
      </button>
      <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1" aria-label="Volume Control" />
    </div>
  </div>

  <div id="trackList" aria-label="Track List" role="list"></div>

</div>

<div class="ambience-panel" aria-label="Ambient Sound Controls">
  <label>üåß Rain <input type="range" min="0" max="1" step="0.01" value="0.4" data-id="rain" /></label>
  <label>üìº Vinyl <input type="range" min="0" max="1" step="0.01" value="0.3" data-id="vinyl" /></label>
  <label>‚òï Cafe <input type="range" min="0" max="1" step="0.01" value="0.3" data-id="cafe" /></label>
  <label>üî• Fireplace <input type="range" min="0" max="1" step="0.01" value="0.3" data-id="fire" /></label>
  <label>üçÉ Wind <input type="range" min="0" max="1" step="0.01" value="0.3" data-id="wind" /></label>
  <label>üåÉ City <input type="range" min="0" max="1" step="0.01" value="0.2" data-id="city" /></label>
  <label>‚å®Ô∏è Typing <input type="range" min="0" max="1" step="0.01" value="0.2" data-id="type" /></label>
  <label>üå≥ Outside <input type="range" min="0" max="1" step="0.01" value="0.2" data-id="outside" /></label>
  <label>üèñ Beach <input type="range" min="0" max="1" step="0.01" value="0.2" data-id="beach" /></label>
</div>

<!-- Ambient audio sources -->
<audio id="rain" loop src="https://res.cloudinary.com/dvtt0ymce/video/upload/v1754236332/Rain_5_ommf7e.wav"></audio>
<audio id="vinyl" loop src="https://res.cloudinary.com/dvtt0ymce/video/upload/v1754236422/Vinyl_1_lrn7bh.wav"></audio>
<audio id="cafe" loop src="https://res.cloudinary.com/dvtt0ymce/video/upload/v1754236698/sandwich-cafe-31183_wnkw8j.mp3"></audio>
<audio id="fire" loop src="https://res.cloudinary.com/dvtt0ymce/video/upload/v1754236735/campfirefireplace-crackling-268525_bg9ksg.mp3"></audio>
<audio id="wind" loop src="https://res.cloudinary.com/dvtt0ymce/video/upload/v1754236875/wind-blowing-sfx-12809_ptsspy.mp3"></audio>
<audio id="city" loop src="https://res.cloudinary.com/dvtt0ymce/video/upload/v1754236956/015965_city-night-56166_ebsgdp.mp3"></audio>
<audio id="type" loop src="https://res.cloudinary.com/dvtt0ymce/video/upload/v1754237017/typing-keyboard-sound-254462_t0ppdc.mp3"></audio>
<audio id="outside" loop src="https://res.cloudinary.com/dvtt0ymce/video/upload/v1754237083/Outside_2_exboxa.wav"></audio>
<audio id="beach" loop src="https://res.cloudinary.com/dvtt0ymce/video/upload/v1754237120/Beach_2_r7t5yw.wav"></audio>

<!-- Main audio player -->
<audio id="audioPlayer" crossorigin="anonymous"></audio>

<script>
(() => {
  // Projects & tracks data (use your real Cloudinary URLs and Spotify links here)
  const projects = [
    {
      id: "pillowcore",
      name: "Pillowcore Radio",
      cover: "https://res.cloudinary.com/dvtt0ymce/image/upload/v1754227293/pillow_radio_xrdpqc.png",
      spotifyBase: "https://open.spotify.com/track/", // You can append track id later if available
      tracks: [
        { title: "Glow Sink", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225847/Glow_Sink_sprxbn.mp3" },
        { title: "Paper Walls", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225847/Paper_Walls_est5ei.mp3" },
        { title: "Lavender Shadows", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225846/Lavender_Shadows_s3wayo.mp3" },
        { title: "Snooze Signal", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225844/Snooze_Signal_vqjo70.mp3" },
        { title: "Dream Archive", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225842/Dream_Archive_wrtdy3.mp3" },
        { title: "Warm Silence", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225842/Warm_Silence_zxijcq.mp3" },
        { title: "Curtains Closed", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225842/Curtains_Closed_nqpgtq.mp3" },
        { title: "Ceiling Fan Dreams", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225842/Ceiling_Fan_Dreams_xqlsq7.mp3" },
        { title: "Whispers in Blue", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225841/Whispers_in_Blue_tgitgu.mp3" },
        { title: "Rain on 4th Street", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225841/Rain_on_4th_Street_vt5sb9.mp3" },
        { title: "Moonlit Linen", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225841/Moonlit_Linen_nwjuzr.mp3" },
        { title: "Midnight Left on Read", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225841/Midnight_Left_on_Read_vy5iqm.mp3" }
      ]
    },
    {
      id: "eveningstatic",
      name: "Evening Static",
      cover: "https://res.cloudinary.com/dvtt0ymce/image/upload/v1754229102/056f89b5bdd7b2944636c4e480196abe_1_bhyub6.jpg",
      spotifyBase: "https://open.spotify.com/track/",
      tracks: [
        { title: "Curtains Breathing Slow", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229134/Curtains_Breathing_Slow_si8vdi.mp3" },
        { title: "Heard My Name in the Hiss", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229134/Heard_My_Name_in_the_Hiss_yi1jfb.mp3" },
        { title: "Stayed Just Long Enough", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229136/Stayed_Just_Long_Enough_wlkxsb.mp3" },
        { title: "Memories on the Window Glass", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229137/Memories_on_the_Window_Glass_uw4vxm.mp3" },
        { title: "TV Snow in My Mind", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229138/TV_Snow_in_My_Mind_oxtsqi.mp3" },
        { title: "Pages Left Open", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229139/Pages_Left_Open_r4bxvz.mp3" },
        { title: "The Fan Still Spins", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229139/The_Fan_Still_Spins_qba31z.mp3" },
        { title: "When the Floorboard Creaked", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229142/When_the_Floorboard_Creaked_ljcd2m.mp3" },
        { title: "A Thread Pulled from the Moon", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229143/A_Thread_Pulled_from_the_Moon_kqjhdq.mp3" },
        { title: "Between the Glow and the Silence", url: "https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229143/Between_the_Glow_and_the_Silence_xv6mht.mp3" }
      ]
    }
  ];

  // DOM references
  const projectListEl = document.getElementById("projectList");
  const trackListEl = document.getElementById("trackList");
  const nowPlayingEl = document.getElementById("nowPlaying");
  const vinylEl = document.getElementById("vinyl");
  const audio = document.getElementById("audioPlayer");
  const playPauseBtn = document.getElementById("playPauseBtn");
  const playIcon = document.getElementById("playIcon");
  const pauseIcon = document.getElementById("pauseIcon");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const repeatBtn = document.getElementById("repeatBtn");
  const shuffleBtn = document.getElementById("shuffleBtn");
  const seekBar = document.getElementById("seekBar");
  const volumeSlider = document.getElementById("volumeSlider");

  // Ambient sounds
  const ambienceAudios = {
    rain: document.getElementById("rain"),
    vinyl: document.getElementById("vinyl"),
    cafe: document.getElementById("cafe"),
    fire: document.getElementById("fire"),
    wind: document.getElementById("wind"),
    city: document.getElementById("city"),
    type: document.getElementById("type"),
    outside: document.getElementById("outside"),
    beach: document.getElementById("beach"),
  };

  // Playback & state
  let currentProjectIndex = 0;
  let currentTrackIndex = 0;
  let isPlaying = false;
  let isRepeat = false;
  let isShuffle = false;

  // Helpers
  function formatTime(sec) {
    const minutes = Math.floor(sec / 60) || 0;
    const seconds = Math.floor(sec % 60) || 0;
    return `${minutes}:${seconds < 10 ? "0" : ""}${seconds}`;
  }

  // Load projects into left sidebar
  function renderProjects() {
    projectListEl.innerHTML = "";
    projects.forEach((proj, i) => {
      const pEl = document.createElement("div");
      pEl.className = "project" + (i === currentProjectIndex ? " active" : "");
      pEl.setAttribute("role", "listitem");
      pEl.setAttribute("tabindex", "0");
      pEl.innerHTML = `
        <img src="${proj.cover}" alt="${proj.name} cover" />
        <div class="project-name">${proj.name}</div>
      `;
      pEl.onclick = () => {
        if (currentProjectIndex !== i) {
          selectProject(i, false);
        }
      };
      pEl.onkeydown = (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          pEl.click();
        }
      };
      projectListEl.appendChild(pEl);
    });
  }

  // Load track list for selected project
  function renderTracks() {
    trackListEl.innerHTML = "";
    const proj = projects[currentProjectIndex];
    proj.tracks.forEach((track, i) => {
      const tEl = document.createElement("div");
      tEl.className = "track" + (i === currentTrackIndex ? " active" : "");
      tEl.setAttribute("role", "listitem");
      tEl.setAttribute("tabindex", "0");
      tEl.innerHTML = `
        <div class="track-info">
          <div class="track-title">${track.title}</div>
        </div>
        <button class="spotify-btn" title="Open on Spotify" aria-label="Open ${track.title} on Spotify">
          <svg class="spotify-icon" viewBox="0 0 24 24" fill="#1DB954" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 0C5.3725 0 0 5.3725 0 12C0 18.6275 5.3725 24 12 24C18.6275 24 24 18.6275 24 12C24 5.3725 18.6275 0 12 0ZM17.45 17.2875C17.075 17.6625 16.4575 17.7 16.08 17.325C13.635 15.465 9.6825 15.42 6.6375 16.8375C6.2175 17.05 5.715 16.8125 5.5125 16.395C5.31 15.9775 5.5475 15.48 5.9675 15.2775C9.455 13.5475 14.325 13.6175 17.1625 15.4875C17.535 15.8525 17.825 16.605 17.45 17.2875ZM19.02 14.07C18.6075 14.595 17.85 14.7 17.3775 14.2575C14.0025 11.55 8.25 11.4075 4.5475 12.9225C4.0025 13.1325 3.45 12.795 3.2475 12.24C3.045 11.685 3.3825 11.13 3.93 10.9275C8.2925 9.03 15.225 9.24 19.1375 12.09C19.605 12.4875 19.4325 13.5375 19.02 14.07ZM19.1525 10.1175C13.7175 6.8725 7.0725 7.1175 3.3675 8.535C2.775 8.745 2.2275 8.28 2.0175 7.705C1.8075 7.13 2.2725 6.5775 2.85 6.3675C7.425 4.2975 14.6925 4.0275 20.175 7.4625C20.835 7.8675 20.9975 8.9075 20.25 9.51C19.5075 10.1325 19.3325 9.82 19.1525 10.1175Z"/>
          </svg>
        </button>
      `;
      tEl.onclick = () => {
        if (currentTrackIndex !== i || currentProjectIndex !== currentProjectIndex) {
          playTrack(i);
        }
      };
      tEl.onkeydown = (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          tEl.click();
        }
      };
      // Spotify button click handler
      tEl.querySelector(".spotify-btn").onclick = (ev) => {
        ev.stopPropagation();
        // Build Spotify search URL fallback
        const searchQuery = encodeURIComponent(`KozyBeats ${track.title}`);
        const url = `https://open.spotify.com/search/${searchQuery}`;
        window.open(url, "_blank");
      };

      trackListEl.appendChild(tEl);
    });
  }

  // Select project
  function selectProject(index, autoplay = true) {
    if (index < 0 || index >= projects.length) return;
    currentProjectIndex = index;
    renderProjects();
    renderTracks();
    if (autoplay) {
      playTrack(0);
    }
  }

  // Play a specific track in current project
  function playTrack(trackIndex) {
    const proj = projects[currentProjectIndex];
    if (trackIndex < 0 || trackIndex >= proj.tracks.length) return;
    currentTrackIndex = trackIndex;
    const track = proj.tracks[trackIndex];
    audio.src = track.url;
    audio.play().then(() => {
      isPlaying = true;
      updatePlayPauseButton();
      updateNowPlaying();
      updateActiveTrack();
      updateVinyl();
    }).catch(e => {
      console.warn("Playback error", e);
    });
  }

  // Update "Now Playing" text
  function updateNowPlaying() {
    const proj = projects[currentProjectIndex];
    const track = proj.tracks[currentTrackIndex];
    nowPlayingEl.textContent = `Now Playing: KozyBeats - ${track.title}`;
  }

  // Update active track styling
  function updateActiveTrack() {
    const tracks = trackListEl.querySelectorAll(".track");
    tracks.forEach((t, i) => {
      t.classList.toggle("active", i === currentTrackIndex);
    });
  }

  // Update vinyl background image (cover of current song)
  function updateVinyl() {
    const proj = projects[currentProjectIndex];
    vinylEl.style.backgroundImage = `url(${proj.cover})`;
  }

  // Play or pause toggle
  function togglePlayPause() {
    if (!audio.src) return;
    if (audio.paused) {
      audio.play();
      isPlaying = true;
    } else {
      audio.pause();
      isPlaying = false;
    }
    updatePlayPauseButton();
  }

  // Update play/pause button icons
  function updatePlayPauseButton() {
    if (isPlaying) {
      playIcon.style.display = "none";
      pauseIcon.style.display = "block";
      playPauseBtn.setAttribute("aria-label", "Pause");
      playPauseBtn.setAttribute("title", "Pause");
    } else {
      playIcon.style.display = "block";
      pauseIcon.style.display = "none";
      playPauseBtn.setAttribute("aria-label", "Play");
      playPauseBtn.setAttribute("title", "Play");
    }
  }

  // Next track logic
  function nextTrack() {
    const proj = projects[currentProjectIndex];
    if (isShuffle) {
      const randomIndex = Math.floor(Math.random() * proj.tracks.length);
      playTrack(randomIndex);
    } else {
      if (currentTrackIndex + 1 < proj.tracks.length) {
        playTrack(currentTrackIndex + 1);
      } else {
        // End of project tracks
        if (isRepeat) {
          playTrack(0);
        } else {
          // Move to next project if exists
          const nextProjIndex = (currentProjectIndex + 1) % projects.length;
          selectProject(nextProjIndex);
        }
      }
    }
  }

  // Previous track logic
  function prevTrack() {
    if (audio.currentTime > 3) {
      audio.currentTime = 0;
    } else if (currentTrackIndex > 0) {
      playTrack(currentTrackIndex - 1);
    } else {
      // First track, restart or go to last track of prev project
      if (isRepeat) {
        playTrack(0);
      } else {
        const prevProjIndex = (currentProjectIndex - 1 + projects.length) % projects.length;
        selectProject(prevProjIndex);
      }
    }
  }

  // Toggle repeat mode
  function toggleRepeat() {
    isRepeat = !isRepeat;
    repeatBtn.style.backgroundColor = isRepeat ? "rgba(255,165,0,1)" : "rgba(255,165,0,0.9)";
    repeatBtn.setAttribute("aria-label", isRepeat ? "Repeat On" : "Repeat Off");
    repeatBtn.setAttribute("title", isRepeat ? "Repeat On" : "Repeat Off");
  }

  // Toggle shuffle mode
  function toggleShuffle() {
    isShuffle = !isShuffle;
    shuffleBtn.style.backgroundColor = isShuffle ? "rgba(255,165,0,1)" : "rgba(255,165,0,0.9)";
    shuffleBtn.setAttribute("aria-label", isShuffle ? "Shuffle On" : "Shuffle Off");
    shuffleBtn.setAttribute("title", isShuffle ? "Shuffle On" : "Shuffle Off");
  }

  // Seek bar update
  function updateSeekBar() {
    if (audio.duration) {
      const percent = (audio.currentTime / audio.duration) * 100;
      seekBar.value = percent;
    }
  }

  // Seek bar input handler
  function seekAudio() {
    if (audio.duration) {
      const seekTime = (seekBar.value / 100) * audio.duration;
      audio.currentTime = seekTime;
    }
  }

  // Volume control
  function setVolume() {
    audio.volume = volumeSlider.value;
  }

  // Update ambient sound volumes
  function updateAmbienceVolume(id, value) {
    if (ambienceAudios[id]) {
      ambienceAudios[id].volume = value;
      if (value > 0 && ambienceAudios[id].paused) {
        ambienceAudios[id].play().catch(() => {});
      } else if (value == 0) {
        ambienceAudios[id].pause();
      }
    }
  }

  // Initialize ambient sounds volumes & play
  function initAmbience() {
    Object.entries(ambienceAudios).forEach(([id, audioEl]) => {
      const slider = document.querySelector(`.ambience-panel input[data-id="${id}"]`);
      if (slider) {
        audioEl.volume = slider.value;
        if (slider.value > 0) {
          audioEl.play().catch(() => {});
        }
        slider.addEventListener("input", e => {
          updateAmbienceVolume(id, e.target.value);
        });
      }
    });
  }

  // Particles creation & animation
  function createParticles(num = 80) {
    const container = document.getElementById("particles");
    for(let i=0; i<num; i++) {
      const p = document.createElement("div");
      p.className = "particle";
      p.style.left = `${Math.random() * 100}vw`;
      p.style.top = `${Math.random() * 100}vh`;
      p.style.width = p.style.height = `${2 + Math.random() * 4}px`;
      p.style.animationDuration = `${10 + Math.random() * 15}s`;
      p.style.animationDelay = `${Math.random() * 15}s`;
      container.appendChild(p);
    }
  }

  // Initialize
  function init() {
    renderProjects();
    selectProject(0);

    // Controls event listeners
    playPauseBtn.onclick = togglePlayPause;
    prevBtn.onclick = prevTrack;
    nextBtn.onclick = nextTrack;
    repeatBtn.onclick = toggleRepeat;
    shuffleBtn.onclick = toggleShuffle;
    seekBar.oninput = seekAudio;
    volumeSlider.oninput = setVolume;

    // Audio event listeners
    audio.ontimeupdate = updateSeekBar;
    audio.onended = nextTrack;

    // Initialize ambience sounds
    initAmbience();

    // Create particles effect
    createParticles();
  }

  // Run on page load
  window.onload = init;
})();
</script>

</body>
</html>

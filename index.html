<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KozyBeats Lofi Player</title>
<style>
  * { box-sizing: border-box; }
  body, html {
    margin: 0; padding: 0;
    height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #1e1e1e;
    color: #ddd;
    overflow: hidden;
  }
  a { color: inherit; text-decoration: none; }
  button {
    cursor: pointer;
    background: none;
    border: none;
    color: #ddd;
    font-size: 1.2rem;
    padding: 6px 10px;
    border-radius: 6px;
    transition: background 0.2s;
  }
  button:hover { background: rgba(255, 184, 108, 0.3); }
  button:disabled { opacity: 0.3; cursor: not-allowed; }
  h2, h3 {
    margin: 10px 0 8px 0;
    font-weight: 600;
    color: #ffb86c;
  }
  #app {
    display: grid;
    grid-template-columns: 250px 1fr 350px;
    grid-template-rows: 1fr 90px;
    grid-template-areas:
      "projects main tracks"
      "controls controls controls";
    height: 100vh;
    position: relative;
  }
  #projects {
    grid-area: projects;
    background: rgba(30,30,30,0.85);
    overflow-y: auto;
    padding: 15px 10px 20px 10px;
    border-right: 1px solid #333;
  }
  #projects h2 { text-align: center; }
  .project-item {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    cursor: pointer;
    padding: 6px 6px;
    border-radius: 8px;
    transition: background 0.3s;
  }
  .project-item:hover { background: rgba(255, 184, 108, 0.15); }
  .project-item.active { background: rgba(255, 184, 108, 0.4); }
  .project-item img {
    width: 48px;
    height: 48px;
    border-radius: 6px;
    object-fit: cover;
    margin-right: 12px;
    flex-shrink: 0;
  }
  .project-item span { font-weight: 600; font-size: 1rem; }
  #track-list-container {
    grid-area: tracks;
    background: rgba(30,30,30,0.85);
    overflow-y: auto;
    padding: 15px 20px 20px 20px;
    border-left: 1px solid #333;
  }
  #track-list-container h3 {
    text-align: center;
    color: #ffb86c;
    margin-bottom: 15px;
  }
  #track-list {
    max-height: calc(100vh - 100px);
    overflow-y: auto;
  }
  .track-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    margin-bottom: 10px;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.05);
    transition: background 0.3s;
    cursor: pointer;
  }
  .track-item.playing { background: rgba(255, 184, 108, 0.3); }
  .track-item:hover { background: rgba(255, 184, 108, 0.15); }
  .track-info {
    display: flex;
    flex-direction: column;
    max-width: 70%;
  }
  .track-title {
    font-weight: 600;
    font-size: 1rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .track-duration {
    font-size: 0.8rem;
    color: #bbb;
    margin-top: 2px;
  }
  #main {
    grid-area: main;
    position: relative;
    overflow: hidden;
  }
  #background-video {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    object-fit: cover;
    filter: blur(10px) brightness(0.5);
    z-index: 0;
  }
  #particles-canvas {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
    z-index: 1;
  }
  #vinyl-container {
    position: absolute;
    bottom: 130px;
    left: 50%;
    transform: translateX(-50%);
    width: 150px;
    height: 150px;
    z-index: 5;
    user-select: none;
  }
  #vinyl {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    box-shadow:
      0 0 15px rgba(255, 184, 108, 0.6),
      inset 0 0 10px rgba(255, 184, 108, 0.8);
    animation: spin 15s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  #controls {
    grid-area: controls;
    background: rgba(30,30,30,0.95);
    border-top: 1px solid #333;
    display: flex;
    align-items: center;
    padding: 0 20px;
    gap: 12px;
  }
  #now-playing-info {
    color: #ffb86c;
    font-weight: 600;
    min-width: 220px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #progress-container {
    flex-grow: 1;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  #current-time, #duration {
    font-size: 0.85rem;
    color: #aaa;
    width: 45px;
    text-align: center;
    user-select: none;
  }
  #progress-bar {
    flex-grow: 1;
    appearance: none;
    height: 6px;
    border-radius: 3px;
    background: #444;
    cursor: pointer;
  }
  #progress-bar::-webkit-slider-thumb {
    appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: #ffb86c;
    cursor: pointer;
    margin-top: -4px;
    transition: background 0.2s;
  }
  #progress-bar:hover::-webkit-slider-thumb {
    background: #ffca28;
  }
  .control-button {
    font-size: 1.6rem;
    color: #ffb86c;
    background: none;
    border: none;
    cursor: pointer;
    transition: color 0.2s;
    user-select: none;
  }
  .control-button:hover { color: #ffc107; }
  #volume-container {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #ffb86c;
  }
  #volume-slider { width: 100px; }
  #btn-ambience-toggle {
    font-size: 1.5rem;
    color: #ffb86c;
    cursor: pointer;
    background: none;
    border: none;
  }
  #ambience-container {
    position: absolute;
    bottom: 95px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(30,30,30,0.9);
    border-radius: 12px;
    padding: 10px 18px;
    display: none;
    z-index: 20;
    width: 320px;
    max-height: 180px;
    overflow-y: auto;
  }
  .ambience-sound {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }
  .ambience-label {
    flex-grow: 1;
    user-select: none;
  }
  .ambience-toggle {
    width: 18px;
    height: 18px;
  }
  .ambience-volume {
    width: 80px;
  }
  #projects::-webkit-scrollbar,
  #track-list-container::-webkit-scrollbar,
  #track-list::-webkit-scrollbar,
  #ambience-container::-webkit-scrollbar {
    width: 8px;
  }
  #projects::-webkit-scrollbar-thumb,
  #track-list-container::-webkit-scrollbar-thumb,
  #track-list::-webkit-scrollbar-thumb,
  #ambience-container::-webkit-scrollbar-thumb {
    background: rgba(255, 184, 108, 0.3);
    border-radius: 4px;
  }
  @media (max-width: 900px) {
    #app {
      grid-template-columns: 1fr;
      grid-template-rows: auto 90px 300px;
      grid-template-areas:
        "main"
        "controls"
        "tracks";
    }
    #projects { display: none; }
    #track-list-container {
      grid-area: tracks;
      border-left: none;
      border-top: 1px solid #333;
    }
  }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
<div id="app">
  <div id="projects"><h2>Projects & Singles</h2></div>
  <div id="main">
    <video autoplay muted loop id="background-video" src="https://res.cloudinary.com/dvtt0ymce/video/upload/v1754228640/Cat_Mushroom_Animated_Digital_Wide_PC_Background_HD_Live_-_Etsy_Video_Video___Anime_wallpaper_Cute_wallpapers_Art_whcjmg.mp4"></video>
    <canvas id="particles-canvas"></canvas>
    <div id="vinyl-container">
      <img id="vinyl" src="https://res.cloudinary.com/dvtt0ymce/image/upload/v1754230124/Vinyl-PNG-Transparent-Image_lnmiyw.png" alt="Vinyl Cover" />
    </div>
  </div>
  <div id="track-list-container">
    <h3 id="track-list-title">Tracks</h3>
    <div id="track-list"></div>
  </div>
  <div id="controls">
    <div id="now-playing-info">KozyBeats - Nothing Playing</div>
    <div id="progress-container">
      <div id="current-time">0:00</div>
      <input type="range" id="progress-bar" value="0" min="0" max="100" step="0.1" />
      <div id="duration">0:00</div>
    </div>
    <button class="control-button" id="btn-prev" title="Previous Track"><i class="fa-solid fa-backward-step"></i></button>
    <button class="control-button" id="btn-play" title="Play/Pause"><i class="fa-solid fa-play"></i></button>
    <button class="control-button" id="btn-next" title="Next Track"><i class="fa-solid fa-forward-step"></i></button>
    <button class="control-button" id="btn-shuffle" title="Shuffle"><i class="fa-solid fa-shuffle"></i></button>
    <button class="control-button" id="btn-repeat" title="Repeat"><i class="fa-solid fa-repeat"></i></button>
    <button class="control-button" id="btn-mute" title="Mute/Unmute"><i class="fa-solid fa-volume-high"></i></button>
    <div id="volume-container">
      <i class="fa-solid fa-volume-low"></i>
      <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.7" />
    </div>
    <button class="control-button" id="btn-ambience-toggle" title="Toggle Ambience Sounds"><i class="fa-solid fa-wind"></i></button>
  </div>
  <div id="ambience-container"></div>
</div>

<script>
(() => {
  const projects = [
    {
      id: 'pillowcore-radio',
      name: 'Pillowcore Radio',
      cover: 'https://res.cloudinary.com/dvtt0ymce/image/upload/v1754227293/pillow_radio_xrdpqc.png',
      spotify: '', // placeholder for Spotify project link if needed
      tracks: [
        { title: 'Ceiling Fan Dreams', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225842/Ceiling_Fan_Dreams_xqlsq7.mp3', spotify: '', duration: 0 },
        { title: 'Curtains Closed', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225842/Curtains_Closed_nqpgtq.mp3', spotify: '', duration: 0 },
        { title: 'Dream Archive', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225842/Dream_Archive_wrtdy3.mp3', spotify: '', duration: 0 },
        { title: 'Glow Sink', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225847/Glow_Sink_sprxbn.mp3', spotify: '', duration: 0 },
        { title: 'Lavender Shadows', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225846/Lavender_Shadows_s3wayo.mp3', spotify: '', duration: 0 },
        { title: 'Midnight Left on Read', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225841/Midnight_Left_on_Read_vy5iqm.mp3', spotify: '', duration: 0 },
        { title: 'Moonlit Linen', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225841/Moonlit_Linen_nwjuzr.mp3', spotify: '', duration: 0 },
        { title: 'Paper Walls', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225847/Paper_Walls_est5ei.mp3', spotify: '', duration: 0 },
        { title: 'Rain on 4th Street', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225841/Rain_on_4th_Street_vt5sb9.mp3', spotify: '', duration: 0 },
        { title: 'Snooze Signal', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225844/Snooze_Signal_vqjo70.mp3', spotify: '', duration: 0 },
        { title: 'Warm Silence', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225842/Warm_Silence_zxijcq.mp3', spotify: '', duration: 0 },
        { title: 'Whispers in Blue', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754225841/Whispers_in_Blue_tgitgu.mp3', spotify: '', duration: 0 },
      ],
    },
    {
      id: 'evening-static',
      name: 'Evening Static',
      cover: 'https://res.cloudinary.com/dvtt0ymce/image/upload/v1754229102/056f89b5bdd7b2944636c4e480196abe_1_bhyub6.jpg',
      spotify: '', // placeholder
      tracks: [
        { title: 'Curtains Breathing Slow', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229902/Curtains_Breathing_Slow_cx3y0g.mp3', spotify: '', duration: 0 },
        { title: 'Heard My Name in the Hiss', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229902/Heard_My_Name_in_the_Hiss_c1j1u8.mp3', spotify: '', duration: 0 },
        { title: 'Stayed Just Long Enough', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229902/Stayed_Just_Long_Enough_nkzdsp.mp3', spotify: '', duration: 0 },
        { title: 'Memories on the Window Glass', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229903/Memories_on_the_Window_Glass_t9zvtt.mp3', spotify: '', duration: 0 },
        { title: 'TV Snow in My Mind', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229903/TV_Snow_in_My_Mind_v6u8so.mp3', spotify: '', duration: 0 },
        { title: 'Pages Left Open', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229903/Pages_Left_Open_xtrfcq.mp3', spotify: '', duration: 0 },
        { title: 'The Fan Still Spins', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229903/The_Fan_Still_Spins_o9jra0.mp3', spotify: '', duration: 0 },
        { title: 'When the Floorboard Creaked', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229903/When_the_Floorboard_Creaked_fm1jes.mp3', spotify: '', duration: 0 },
        { title: 'A Thread Pulled from the Moon', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229903/A_Thread_Pulled_from_the_Moon_u1vr4k.mp3', spotify: '', duration: 0 },
        { title: 'Between the Glow and the Silence', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229903/Between_the_Glow_and_the_Silence_zpwr8z.mp3', spotify: '', duration: 0 },
      ],
    },
    {
      id: 'singles',
      name: 'Singles',
      cover: 'https://res.cloudinary.com/dvtt0ymce/image/upload/v1754229548/Single_Cover_dptsk5.jpg',
      spotify: '', // placeholder
      tracks: [
        { title: 'Cozy Nights', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229601/Cozy_Nights_mxk94m.mp3', spotify: '', duration: 0 },
        { title: 'Silent Footsteps', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754229601/Silent_Footsteps_q8kr6w.mp3', spotify: '', duration: 0 },
      ],
    }
  ];

  // Your ambience sounds (exact ones you sent me):
  const ambienceSounds = [
    { id: 'rain', name: 'Rain', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754236332/Rain_5_ommf7e.wav' },
    { id: 'vinyl', name: 'Vinyl Crackle', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754236422/Vinyl_1_lrn7bh.wav' },
    { id: 'cafe', name: 'Cafe Ambience', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754236698/sandwich-cafe-31183_wnkw8j.mp3' },
    { id: 'campfire', name: 'Campfire', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754236735/campfirefireplace-crackling-268525_bg9ksg.mp3' },
    { id: 'wind', name: 'Wind', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754236875/wind-blowing-sfx-12809_ptsspy.mp3' },
    { id: 'citynight', name: 'City Night', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754236956/015965_city-night-56166_ebsgdp.mp3' },
    { id: 'typing', name: 'Typing Keyboard', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754237017/typing-keyboard-sound-254462_t0ppdc.mp3' },
    { id: 'outside', name: 'Outside Ambience', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754237083/Outside_2_exboxa.wav' },
    { id: 'beach', name: 'Beach Ambience', src: 'https://res.cloudinary.com/dvtt0ymce/video/upload/v1754237120/Beach_2_r7t5yw.wav' },
  ];

  // Global state variables
  let currentProjectIndex = 0;
  let currentTrackIndex = 0;
  let isPlaying = false;
  let isShuffle = false;
  let repeatMode = 0; // 0: no repeat, 1: repeat track, 2: repeat all
  let audio = new Audio();
  let ambienceAudios = {};
  let ambienceStates = {}; // id: {enabled: bool, volume: float}
  let ambienceContainer, btnAmbienceToggle;
  let isAmbienceVisible = false;
  let shuffleOrder = [];

  // DOM refs
  const projectsContainer = document.getElementById('projects');
  const trackListContainer = document.getElementById('track-list');
  const trackListTitle = document.getElementById('track-list-title');
  const nowPlayingInfo = document.getElementById('now-playing-info');
  const progressBar = document.getElementById('progress-bar');
  const currentTimeDisplay = document.getElementById('current-time');
  const durationDisplay = document.getElementById('duration');
  const btnPlay = document.getElementById('btn-play');
  const btnPrev = document.getElementById('btn-prev');
  const btnNext = document.getElementById('btn-next');
  const btnShuffle = document.getElementById('btn-shuffle');
  const btnRepeat = document.getElementById('btn-repeat');
  const btnMute = document.getElementById('btn-mute');
  const volumeSlider = document.getElementById('volume-slider');
  const vinylImage = document.getElementById('vinyl');
  ambienceContainer = document.getElementById('ambience-container');
  btnAmbienceToggle = document.getElementById('btn-ambience-toggle');

  // Helpers
  function formatTime(seconds) {
    if (!seconds || isNaN(seconds)) return '0:00';
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60);
    return `${m}:${s < 10 ? '0' : ''}${s}`;
  }

  // Initialize ambience audio elements
  function setupAmbience() {
    ambienceSounds.forEach(sound => {
      const audioAmb = new Audio(sound.src);
      audioAmb.loop = true;
      audioAmb.volume = 0.3;
      ambienceAudios[sound.id] = audioAmb;
      ambienceStates[sound.id] = { enabled: false, volume: 0.3 };
    });
  }

  // Render ambience controls UI
  function renderAmbienceControls() {
    ambienceContainer.innerHTML = '';
    ambienceSounds.forEach(sound => {
      const div = document.createElement('div');
      div.classList.add('ambience-sound');
      div.innerHTML = `
        <label class="ambience-label" for="ambience-toggle-${sound.id}">${sound.name}</label>
        <input type="checkbox" id="ambience-toggle-${sound.id}" class="ambience-toggle" />
        <input type="range" id="ambience-volume-${sound.id}" class="ambience-volume" min="0" max="1" step="0.01" value="0.3" />
      `;
      ambienceContainer.appendChild(div);

      // Checkbox toggle
      const toggle = div.querySelector(`#ambience-toggle-${sound.id}`);
      toggle.checked = ambienceStates[sound.id].enabled;
      toggle.addEventListener('change', e => {
        ambienceStates[sound.id].enabled = e.target.checked;
        if (e.target.checked) {
          ambienceAudios[sound.id].play();
        } else {
          ambienceAudios[sound.id].pause();
        }
      });

      // Volume slider
      const volSlider = div.querySelector(`#ambience-volume-${sound.id}`);
      volSlider.value = ambienceStates[sound.id].volume;
      volSlider.addEventListener('input', e => {
        const val = parseFloat(e.target.value);
        ambienceStates[sound.id].volume = val;
        ambienceAudios[sound.id].volume = val;
      });
    });
  }

  // Render projects in left sidebar
  function renderProjects() {
    projectsContainer.innerHTML = '<h2>Projects & Singles</h2>';
    projects.forEach((project, idx) => {
      const div = document.createElement('div');
      div.className = 'project-item' + (idx === currentProjectIndex ? ' active' : '');
      div.dataset.index = idx;
      div.innerHTML = `<img src="${project.cover}" alt="${project.name}"/><span>${project.name}</span>`;
      div.addEventListener('click', () => {
        if (currentProjectIndex !== idx) {
          currentProjectIndex = idx;
          currentTrackIndex = 0;
          loadTrack();
          renderProjects();
          renderTracks();
          playAudio();
        }
      });
      projectsContainer.appendChild(div);
    });
  }

  // Render tracks for current project
  function renderTracks() {
    const project = projects[currentProjectIndex];
    trackListTitle.textContent = `Tracks - ${project.name}`;
    trackListContainer.scrollTop = 0;
    trackListContainer.querySelector('#track-list')?.remove();
    const list = document.createElement('div');
    list.id = 'track-list';

    project.tracks.forEach((track, idx) => {
      const item = document.createElement('div');
      item.className = 'track-item' + (idx === currentTrackIndex ? ' playing' : '');
      item.dataset.index = idx;
      item.innerHTML = `
        <div class="track-info">
          <div class="track-title">${track.title}</div>
          <div class="track-duration">${track.duration > 0 ? formatTime(track.duration) : ''}</div>
        </div>
      `;
      item.addEventListener('click', () => {
        if (currentTrackIndex !== idx) {
          currentTrackIndex = idx;
          loadTrack();
          playAudio();
          renderTracks();
        }
      });
      list.appendChild(item);
    });
    trackListContainer.appendChild(list);
  }

  // Load track audio source
  function loadTrack() {
    const track = projects[currentProjectIndex].tracks[currentTrackIndex];
    audio.src = track.src;
    nowPlayingInfo.textContent = `KozyBeats - ${track.title}`;
    // Update vinyl cover to current track cover (same as project cover as you said)
    vinylImage.src = projects[currentProjectIndex].cover;
    audio.load();
  }

  // Play audio and update play button icon
  function playAudio() {
    audio.play();
    isPlaying = true;
    btnPlay.innerHTML = '<i class="fa-solid fa-pause"></i>';
  }

  // Pause audio and update play button icon
  function pauseAudio() {
    audio.pause();
    isPlaying = false;
    btnPlay.innerHTML = '<i class="fa-solid fa-play"></i>';
  }

  // Play next track
  function playNextTrack() {
    if (isShuffle) {
      // shuffle next
      currentTrackIndex = (currentTrackIndex + 1) % projects[currentProjectIndex].tracks.length;
    } else {
      currentTrackIndex++;
      if (currentTrackIndex >= projects[currentProjectIndex].tracks.length) {
        if (repeatMode === 2) {
          currentTrackIndex = 0;
        } else {
          // move to next project
          currentProjectIndex = (currentProjectIndex + 1) % projects.length;
          currentTrackIndex = 0;
        }
      }
    }
    loadTrack();
    playAudio();
    renderTracks();
    renderProjects();
  }

  // Play previous track
  function playPrevTrack() {
    currentTrackIndex--;
    if (currentTrackIndex < 0) {
      currentProjectIndex = (currentProjectIndex - 1 + projects.length) % projects.length;
      currentTrackIndex = projects[currentProjectIndex].tracks.length - 1;
    }
    loadTrack();
    playAudio();
    renderTracks();
    renderProjects();
  }

  // Toggle shuffle
  function toggleShuffle() {
    isShuffle = !isShuffle;
    btnShuffle.style.color = isShuffle ? '#ffc107' : '#ffb86c';
  }

  // Toggle repeat mode
  function toggleRepeat() {
    repeatMode = (repeatMode + 1) % 3;
    switch (repeatMode) {
      case 0: btnRepeat.style.color = '#ffb86c'; break;
      case 1: btnRepeat.style.color = '#ffc107'; break;
      case 2: btnRepeat.style.color = '#ff6f00'; break;
    }
  }

  // Toggle mute
  function toggleMute() {
    audio.muted = !audio.muted;
    if(audio.muted) {
      btnMute.innerHTML = '<i class="fa-solid fa-volume-xmark"></i>';
    } else {
      btnMute.innerHTML = '<i class="fa-solid fa-volume-high"></i>';
    }
  }

  // Update volume
  function updateVolume(value) {
    audio.volume = value;
    if (audio.volume === 0) {
      btnMute.innerHTML = '<i class="fa-solid fa-volume-xmark"></i>';
    } else {
      btnMute.innerHTML = '<i class="fa-solid fa-volume-high"></i>';
    }
  }

  // Update progress bar and time displays
  function updateProgress() {
    const current = audio.currentTime;
    const duration = audio.duration || 0;
    if(!isNaN(current) && !isNaN(duration) && duration > 0){
      const percent = (current / duration) * 100;
      progressBar.value = percent;
      currentTimeDisplay.textContent = formatTime(current);
      durationDisplay.textContent = formatTime(duration);
    }
  }

  // Seek audio
  function seekAudio(value) {
    if(audio.duration){
      audio.currentTime = (value / 100) * audio.duration;
    }
  }

  // Setup ambience toggle button and container
  function setupAmbienceUI() {
    btnAmbienceToggle.addEventListener('click', () => {
      isAmbienceVisible = !isAmbienceVisible;
      ambienceContainer.style.display = isAmbienceVisible ? 'block' : 'none';
    });
    renderAmbienceControls();
  }

  // Vinyl spinning animation toggle
  function updateVinylSpin() {
    if (isPlaying) {
      vinylImage.style.animationPlayState = 'running';
    } else {
      vinylImage.style.animationPlayState = 'paused';
    }
  }

  // Particle background (simple drifting dots)
  function setupParticles() {
    const canvas = document.getElementById('particles-canvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    let particles = [];

    function init() {
      resize();
      particles = [];
      for (let i = 0; i < 80; i++) {
        particles.push({
          x: Math.random() * width,
          y: Math.random() * height,
          r: 1 + Math.random() * 2,
          d: Math.random() * 100,
          speedX: 0.2 + Math.random() * 0.3,
          speedY: 0.1 + Math.random() * 0.2
        });
      }
      animate();
    }
    function resize() {
      width = window.innerWidth * 0.7;
      height = window.innerHeight;
      canvas.width = width;
      canvas.height = height;
    }
    function animate() {
      ctx.clearRect(0, 0, width, height);
      ctx.fillStyle = 'rgba(255, 184, 108, 0.2)';
      particles.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2, false);
        ctx.fill();
        p.x += p.speedX;
        p.y += p.speedY;
        if(p.x > width) p.x = 0;
        if(p.y > height) p.y = 0;
      });
      requestAnimationFrame(animate);
    }
    window.addEventListener('resize', resize);
    init();
  }

  // Initialize everything
  function init() {
    setupAmbience();
    renderProjects();
    renderTracks();
    setupAmbienceUI();

    // Load first track to initialize durations properly after metadata loads
    loadTrack();

    // Event listeners
    btnPlay.addEventListener('click', () => {
      if (isPlaying) {
        pauseAudio();
      } else {
        playAudio();
      }
      updateVinylSpin();
    });

    btnNext.addEventListener('click', () => {
      playNextTrack();
      updateVinylSpin();
    });

    btnPrev.addEventListener('click', () => {
      playPrevTrack();
      updateVinylSpin();
    });

    btnShuffle.addEventListener('click', () => {
      toggleShuffle();
    });

    btnRepeat.addEventListener('click', () => {
      toggleRepeat();
    });

    btnMute.addEventListener('click', () => {
      toggleMute();
    });

    volumeSlider.addEventListener('input', e => {
      updateVolume(parseFloat(e.target.value));
    });

    progressBar.addEventListener('input', e => {
      seekAudio(parseFloat(e.target.value));
    });

    audio.addEventListener('timeupdate', updateProgress);

    audio.addEventListener('ended', () => {
      if (repeatMode === 1) {
        // repeat current track
        audio.currentTime = 0;
        playAudio();
      } else {
        playNextTrack();
      }
      updateVinylSpin();
    });

    audio.addEventListener('loadedmetadata', () => {
      projects[currentProjectIndex].tracks[currentTrackIndex].duration = audio.duration;
      renderTracks();
      updateProgress();
    });

    updateVolume(volumeSlider.value);
    updateVinylSpin();
    setupParticles();
  }

  // Run init
  init();

})();
</script>
</body>
</html>
